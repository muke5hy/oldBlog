<!DOCTYPE html>
<html lang="en">
<head>
        <title>Optimization of Mongo query, making cursor iteration fast.</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="http://www.mukeshyadav.com/theme/css/main.css" />
        <link href="http://www.mukeshyadav.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Learning the hard way! Full Atom Feed" />
        <link href="http://www.mukeshyadav.com/feeds/category/optimization.atom.xml" type="application/atom+xml" rel="alternate" title="Learning the hard way! Categories Atom Feed" />
</head>
<body>
    <script>
      if (window.location.href.indexOf('ingenioustechie.com') > 0) {
        window.location.href = window.location.href.replace('ingenioustechie.com', "mukeshyadav.com")
      }
    </script>

    <div class="main-nav-container">

        <div class="pure-g">
            <div class="pure-u-1 pure-u-lg-2-3">
                <div class="main-nav">
                    <ul class="main-nav-list">
                        <li class="main-nav-item"><a href="http://www.mukeshyadav.com/" class="pure-menu-link">Learning the hard way!</a></li>

                        <li class="main-nav-item"><a href="http://www.mukeshyadav.com/pages/resume-.html" class="pure-menu-link">Resume</a></li>
                    </ul>
                </div>
             </div>

             <div class="pure-u-1 pure-u-lg-1-3"></div>
        </div>

    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u-3-4 meta-data">
                <a href="http://www.mukeshyadav.com/category/optimization/index.html" class="category">optimization</a><br />

                <a class="author" href="http://www.mukeshyadav.com/author/mukesh.html">Mukesh</a>
                &mdash; <abbr title="2015-11-20T13:36:12+05:30">Fri 20 November 2015</abbr>
            </div>
        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Optimization of Mongo query, making cursor iteration fast.</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p>If you using a mongo, I'm sure you must have come across a situation where you want to do a iteration for .find() command in mongo. 
Querying a Mongo collection for few records will give you faster results, but if you data is more than than 20K-30K or millions and you want to do iteration over it its hell lot of time. </p>
<p>Lets take an example say you have 1 Million records in your users collection and about 98% users a active, to get the result you will do 
  active_users = db.users.find({active:True})
Your above query will get the cursor, now here comes the problem. Mongo does not fetches records in above query it just gets the cursor. To get all the records you need iterate over it. </p>
<div class="highlight"><pre>temp = []
for user in active_users:
    if user.get(&#39;first_name&#39;):
        temp.append(user.get(&#39;first_name&#39;))
</pre></div>


<p>The above query will take about 12+ or around that to create temp list. 12 sec is too huge number for such an small task. (The seconds will differ depending on size of the documents you have in users collection)</p>
<p>Under the hood pymongo in this case is not getting all the records at once in fact it does not gets the results when you do .find() query. Once you start iterating it fetches data from Mongodb in batches. </p>
<p>By default it has 4MB of document size, Maximum of 16MB data mongo can fetch from DB. </p>
<p>to optimize our query we can do </p>
<p>active_users = db.users.find({active:True}).batch_size(2000)</p>
<p>Now again iterate over the active_users and see the magic happen.</p>
    </div>

    <footer>
        <div class="tags">
            <a href="http://www.mukeshyadav.com/tag/MongoDB/index.html">MongoDB</a>
            <a href="http://www.mukeshyadav.com/tag/Query Optimization/index.html">Query Optimization</a>
        </div>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="http://www.mukeshyadav.com/author/mukesh.html">Mukesh</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>

    <div class="entry-content">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'ingenioustechie';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

</div>


</body>
</html>